<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Listening Comprehension Quiz</title>
  <style>
    :root{
      --bg:#0f172a;         /* slate-900 */
      --card:#111827;       /* gray-900 */
      --muted:#94a3b8;      /* slate-400 */
      --text:#e5e7eb;       /* gray-200 */
      --accent:#22c55e;     /* green-500 */
      --accent-2:#10b981;   /* emerald-500 */
      --danger:#ef4444;     /* red-500 */
      --warning:#f59e0b;    /* amber-500 */
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      background: radial-gradient(1200px 800px at 10% -10%, #1f2937 0%, transparent 60%),
                  radial-gradient(1000px 800px at 110% 10%, #1e293b 0%, transparent 60%),
                  var(--bg);
      color:var(--text);
      display:flex; align-items:center; justify-content:center; padding:24px;
    }
    .app{
      width: min(1000px, 100%);
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    header{
      padding:22px 24px; display:flex; align-items:center; gap:12px; justify-content:space-between;
      background:linear-gradient(90deg, rgba(34,197,94,.18), rgba(16,185,129,.10));
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex; gap:12px; align-items:center}
    .logo{width:40px; height:40px; border-radius:12px; background:linear-gradient(135deg, var(--accent), var(--accent-2)); display:grid; place-items:center; font-weight:700; color:#052e16}
    h1{font-size:20px; margin:0}

    main{display:grid; grid-template-columns: 1.2fr .8fr; gap:0;}
    @media (max-width: 900px){ main{grid-template-columns:1fr} }

    .left, .right{padding:20px}
    .card{
      background:rgba(17,24,39,.6);
      border:1px solid rgba(255,255,255,.06);
      border-radius: var(--radius);
      padding:20px; margin-bottom:18px;
    }
    .passage{line-height:1.7; color:#cbd5e1; white-space:pre-wrap}

    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center; margin-top:14px}
    .controls > *{flex:0 0 auto}

    button, select{
      background:rgba(255,255,255,.08);
      color:var(--text);
      border:1px solid rgba(255,255,255,.1);
      padding:10px 14px; border-radius:12px; cursor:pointer; font-weight:600; backdrop-filter: blur(6px);
      transition: transform .06s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{ transform: translateY(-1px); }
    button.primary{ background: linear-gradient(135deg, var(--accent), var(--accent-2)); color:#052e16; border:0; }
    button.danger{ background: linear-gradient(135deg, #ef4444, #f97316); color:#180202; border:0; }
    button:disabled{ opacity:.6; cursor:not-allowed; filter:grayscale(.2)}

    .statbar{display:flex; gap:10px; align-items:center; margin-top:6px}
    .progress{position:relative; flex:1; height:12px; background:rgba(255,255,255,.06); border-radius:999px; overflow:hidden}
    .progress > i{position:absolute; inset:0; width:0%; background:linear-gradient(90deg, var(--accent), var(--accent-2));}
    .tag{font-size:12px; padding:6px 10px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1); border-radius:999px;}

    .q-meta{display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px}
    .timer{font-variant-numeric: tabular-nums; font-weight:700}

    .options{display:grid; gap:10px}
    .option{
      padding:14px; border-radius:14px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); cursor:pointer; transition:.15s ease; position:relative;
    }
    .option:hover{ transform: translateY(-1px); background:rgba(255,255,255,.1) }
    .option.selected{ outline:2px solid var(--accent); }
    .option.correct{ background: linear-gradient(90deg, rgba(34,197,94,.22), rgba(16,185,129,.10)); border-color: rgba(34,197,94,.5); }
    .option.wrong{ background: linear-gradient(90deg, rgba(239,68,68,.22), rgba(249,115,22,.10)); border-color: rgba(239,68,68,.5); }

    .pill{display:inline-flex; gap:8px; align-items:center; padding:8px 12px; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.08); border-radius:999px; font-size:12px}

    .right .card + .card{margin-top:18px}

    .config label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    .config input, .config select{width:100%}
    .grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width: 900px){ .grid{grid-template-columns:1fr} }

    .hidden{display:none}

    .result{
      text-align:center;
      padding:28px;
      background: radial-gradient(600px 200px at 50% -20%, rgba(34,197,94,.15), transparent 70%), rgba(17,24,39,.6);
    }
    .result h2{margin:0 0 6px 0}
    .result .score{
      font-size:42px; font-weight:800;
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      -webkit-background-clip: text; background-clip:text; color:transparent;
    }
    .breakdown{margin-top:14px; font-size:14px; color:#cbd5e1}
    table{width:100%; border-collapse: collapse; margin-top:12px; font-size:14px}
    th, td{padding:10px; border-bottom:1px solid rgba(255,255,255,.08); text-align:left}
    tr:last-child td{border-bottom:0}
    .footer{padding:16px 24px; display:flex; justify-content:space-between; align-items:center; color:var(--muted); font-size:12px}
    a.btn{color:#052e16; text-decoration:none}
  </style>
</head>
<body>
  <div class="app" id="app">
    <header>
      <div class="brand">
        <div class="logo">LC</div>
        <div>
          <h1>Listening Comprehension — Quiz Game</h1>
          <div style="color:var(--muted); font-size:12px">Listen to the passage, then answer timed MCQs. Supports negative marking.</div>
        </div>
      </div>
      <div class="pill" id="statusPill">
        <span>Ready</span>
      </div>
    </header>

    <main>
      <section class="left">
        <div class="card">
          <h2 style="margin-top:0">Passage</h2>
          <div class="passage" id="passageText"></div>
          <div class="controls">
            <button id="btnSpeak" class="primary">▶️ Listen</button>
            <button id="btnStop" disabled>⏹️ Stop</button>
            <label class="pill">
              Voice
              <select id="voiceSelect" style="margin-left:8px"></select>
            </label>
            <label class="pill">Rate <input id="rate" type="range" min="0.7" max="1.3" step="0.05" value="1" style="width:120px"></label>
            <label class="pill">Pitch <input id="pitch" type="range" min="0" max="2" step="0.1" value="1" style="width:120px"></label>
          </div>
          <div class="statbar">
            <div class="progress" aria-label="Passage progress"><i id="listenProgress"></i></div>
            <div class="tag" id="listenTime">0s</div>
          </div>
        </div>

        <div class="card" id="quizCard" aria-live="polite">
          <div class="q-meta">
            <div class="tag" id="qCounter">Question 1 / 1</div>
            <div class="pill">⏱️ Time left: <span class="timer" id="timer">--</span></div>
          </div>
          <h3 id="questionText">Press Start to begin the quiz.</h3>
          <div class="options" id="options"></div>
          <div class="controls" style="margin-top:14px">
            <button id="btnStart" class="primary">Start Quiz</button>
            <button id="btnNext" disabled>Next ▶</button>
            <button id="btnSubmit" class="danger" disabled>Submit Quiz</button>
          </div>
        </div>

        <div class="card result hidden" id="resultCard">
          <h2>Results</h2>
          <div class="score" id="finalScore">0</div>
          <div class="breakdown" id="finalBreakdown"></div>
          <div id="detailTableWrap"></div>
          <div class="controls" style="justify-content:center; margin-top:18px">
            <button id="btnRetry">↻ Try Again</button>
            <button id="btnDownload" class="primary">⬇️ Download Report</button>
          </div>
        </div>
      </section>

      <aside class="right">
        <div class="card config">
          <h3 style="margin-top:0">Settings</h3>
          <div class="grid">
            <div>
              <label>Time per Question (seconds)</label>
              <input type="number" id="timePerQ" min="5" max="120" step="1" value="20">
            </div>
            <div>
              <label>Marks: Correct Answer</label>
              <input type="number" id="marksCorrect" min="1" max="10" step="1" value="4">
            </div>
            <div>
              <label>Negative Marking (wrong answer)</label>
              <input type="number" id="marksWrong" min="0" max="10" step="0.25" value="1">
            </div>
            <div>
              <label>Unanswered Penalty</label>
              <input type="number" id="marksUnanswered" min="0" max="5" step="0.25" value="0">
            </div>
          </div>
          <div class="controls" style="margin-top:12px">
            <button id="btnApply">Apply Settings</button>
            <span style="color:var(--muted); font-size:12px">Changes affect the next question.</span>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">How it works</h3>
          <ul style="margin:0 0 0 18px; color:#cbd5e1">
            <li>Click <strong>Listen</strong> to hear the machine read the passage (Web Speech API).</li>
            <li>Press <strong>Start Quiz</strong> when ready. Each question is timed.</li>
            <li>Scoring uses your settings for marks & negative marking.</li>
            <li>Submit to view a detailed report and download it.</li>
          </ul>
        </div>
      </aside>
    </main>

    <div class="footer">
      <div>Tip: If speech doesn't play, check browser permissions or try Chrome/Edge.</div>
      <div>© Your Quiz Lab</div>
    </div>
  </div>

  <script>
    // ======= CONFIGURABLE PASSAGE & QUESTIONS =======
    const PASSAGE = `In recent years, cities around the world have been planting urban forests to cool neighborhoods, 
reduce air pollution, and improve residents' mental health. A single mature tree can transpire hundreds of liters 
of water on a hot day, lowering local temperatures through evaporative cooling. Beyond climate benefits, tree canopies 
provide habitats for birds and insects, encourage people to walk more, and even increase local business revenue by making 
streets more pleasant. However, success depends on choosing diverse species, ensuring long-term maintenance, and working 
with communities to plant trees where shade and clean air are needed most.`;

    const QUESTIONS = [
      {
        q: "Which is NOT mentioned as a benefit of urban forests?",
        options: [
          "Cooling neighborhoods",
          "Improving mental health",
          "Increasing water pollution",
          "Encouraging people to walk more",
        ],
        correct: 2,
        explain: "The passage mentions reduced air pollution, not increased; and highlights cooling, mental health, and walking."
      },
      {
        q: "What physical process helps lower temperatures according to the passage?",
        options: [
          "Photosynthesis",
          "Evaporative cooling via transpiration",
          "Carbon sequestration",
          "Albedo effect from buildings"
        ],
        correct: 1,
        explain: "A mature tree transpiring water produces evaporative cooling, lowering local temperatures."
      },
      {
        q: "Which factor is important for the long-term success of urban forests?",
        options: [
          "Planting only one fast-growing species",
          "Relying solely on rainfall",
          "Choosing diverse species and ensuring maintenance",
          "Avoiding community input"
        ],
        correct: 2,
        explain: "Diversity, maintenance, and community collaboration are emphasized."
      }
    ];

    // ======= STATE =======
    let state = {
      idx: 0,
      selections: Array(QUESTIONS.length).fill(null),
      results: [],
      timer: null,
      timeLeft: 0,
      totalSeconds: 0,
      marks: {
        correct: 4,
        wrong: 1,          // negative marking value
        unanswered: 0
      }
    };

    // ======= DOM =======
    const passageText = document.getElementById('passageText');
    const btnSpeak = document.getElementById('btnSpeak');
    const btnStop = document.getElementById('btnStop');
    const voiceSelect = document.getElementById('voiceSelect');
    const rate = document.getElementById('rate');
    const pitch = document.getElementById('pitch');
    const listenProgress = document.getElementById('listenProgress');
    const listenTime = document.getElementById('listenTime');

    const qCounter = document.getElementById('qCounter');
    const timerEl = document.getElementById('timer');
    const questionText = document.getElementById('questionText');
    const optionsEl = document.getElementById('options');
    const btnStart = document.getElementById('btnStart');
    const btnNext = document.getElementById('btnNext');
    const btnSubmit = document.getElementById('btnSubmit');
    const statusPill = document.getElementById('statusPill');

    const resultCard = document.getElementById('resultCard');
    const finalScore = document.getElementById('finalScore');
    const finalBreakdown = document.getElementById('finalBreakdown');
    const detailTableWrap = document.getElementById('detailTableWrap');
    const btnRetry = document.getElementById('btnRetry');
    const btnDownload = document.getElementById('btnDownload');

    const timePerQInput = document.getElementById('timePerQ');
    const marksCorrectInput = document.getElementById('marksCorrect');
    const marksWrongInput = document.getElementById('marksWrong');
    const marksUnansweredInput = document.getElementById('marksUnanswered');
    const btnApply = document.getElementById('btnApply');

    passageText.textContent = PASSAGE;

    // ======= SPEECH (Web Speech API) =======
    const synth = window.speechSynthesis;
    let voices = [];

    function populateVoices(){
      voices = synth.getVoices();
      voiceSelect.innerHTML = voices.map((v,i)=>`<option value="${i}">${v.name} (${v.lang})</option>`).join('');
    }
    populateVoices();
    if (speechSynthesis.onvoiceschanged !== undefined) {
      speechSynthesis.onvoiceschanged = populateVoices;
    }

    let speakStartTime = 0;
    let speakInterval = null;

    function speak(text){
      if (!('speechSynthesis' in window)){
        alert('Sorry, your browser does not support the Web Speech API. Try Chrome/Edge.');
        return;
      }
      if (synth.speaking) synth.cancel();
      const utter = new SpeechSynthesisUtterance(text);
      const v = voices[voiceSelect.value] || voices.find(v=>/English|en-/.test(v.lang)) || voices[0];
      if (v) utter.voice = v;
      utter.rate = parseFloat(rate.value);
      utter.pitch = parseFloat(pitch.value);

      utter.onstart = ()=>{
        btnSpeak.disabled = true; btnStop.disabled = false;
        statusPill.firstElementChild.textContent = 'Speaking…';
        speakStartTime = Date.now();
        speakInterval = setInterval(()=>{
          const s = Math.round((Date.now()-speakStartTime)/1000);
          listenTime.textContent = s + 's';
          // fake progress based on duration estimate: 170 wpm -> approx length
          const est = Math.max(8, Math.round(PASSAGE.split(/\s+/).length / 2.8));
          listenProgress.style.width = Math.min(100, (s/est)*100) + '%';
        }, 200);
      }
      utter.onend = ()=>{
        btnSpeak.disabled = false; btnStop.disabled = true;
        statusPill.firstElementChild.textContent = 'Ready';
        clearInterval(speakInterval); speakInterval=null;
      }
      utter.onerror = ()=>{
        btnSpeak.disabled = false; btnStop.disabled = true;
        statusPill.firstElementChild.textContent = 'Error';
        clearInterval(speakInterval); speakInterval=null;
      }

      synth.speak(utter);
    }

    btnSpeak.addEventListener('click', ()=> speak(PASSAGE));
    btnStop.addEventListener('click', ()=>{ synth.cancel(); });

    // ======= QUIZ LOGIC =======
    function applySettings(){
      state.marks.correct = parseFloat(marksCorrectInput.value || 4);
      state.marks.wrong = parseFloat(marksWrongInput.value || 1);
      state.marks.unanswered = parseFloat(marksUnansweredInput.value || 0);
      statusPill.firstElementChild.textContent = `Marks C:+${state.marks.correct} / W:-${state.marks.wrong} / U:-${state.marks.unanswered}`;
    }
    applySettings();

    btnApply.addEventListener('click', ()=>{
      applySettings();
      alert('Settings applied for upcoming questions.');
    });

    function renderQuestion(){
      const i = state.idx;
      const total = QUESTIONS.length;
      const q = QUESTIONS[i];
      qCounter.textContent = `Question ${i+1} / ${total}`;
      questionText.textContent = q.q;
      optionsEl.innerHTML = '';
      q.options.forEach((opt, idx)=>{
        const div = document.createElement('div');
        div.className = 'option';
        div.setAttribute('role', 'button');
        div.setAttribute('tabindex', '0');
        div.textContent = opt;
        if (state.selections[i] === idx) div.classList.add('selected');
        div.addEventListener('click', ()=> selectOption(idx));
        div.addEventListener('keypress', (e)=>{ if (e.key==='Enter' || e.key===' ') selectOption(idx); });
        optionsEl.appendChild(div);
      });

      // Timer
      const perQ = parseInt(timePerQInput.value || '20', 10);
      startTimer(perQ);

      btnNext.disabled = (i === total-1);
      btnSubmit.disabled = (i !== total-1);
    }

    function startTimer(seconds){
      clearInterval(state.timer);
      state.timeLeft = seconds;
      timerEl.textContent = state.timeLeft + 's';
      state.timer = setInterval(()=>{
        state.timeLeft--; state.totalSeconds++;
        timerEl.textContent = state.timeLeft + 's';
        if (state.timeLeft <= 0){
          clearInterval(state.timer);
          lockQuestion('timeout');
          // auto move next if available
          if (state.idx < QUESTIONS.length - 1){
            state.idx++; renderQuestion();
          } else {
            finishQuiz();
          }
        }
      }, 1000);
    }

    function selectOption(idx){
      const i = state.idx;
      state.selections[i] = idx;
      [...optionsEl.children].forEach((el, k)=>{
        el.classList.toggle('selected', k===idx);
      });
    }

    function lockQuestion(reason='next'){
      clearInterval(state.timer);
      const i = state.idx;
      const q = QUESTIONS[i];
      const sel = state.selections[i];
      const isCorrect = sel === q.correct;
      const chosen = typeof sel === 'number';
      const score = chosen ? (isCorrect ? state.marks.correct : -state.marks.wrong) : -state.marks.unanswered;
      state.results[i] = { chosen: sel, isCorrect, score, reason };

      // reveal feedback on options
      [...optionsEl.children].forEach((el, k)=>{
        el.classList.remove('selected');
        if (k === q.correct) el.classList.add('correct');
        if (chosen && k === sel && !isCorrect) el.classList.add('wrong');
        el.style.pointerEvents = 'none';
      });
    }

    btnStart.addEventListener('click', ()=>{
      state.idx = 0;
      state.selections = Array(QUESTIONS.length).fill(null);
      state.results = [];
      state.totalSeconds = 0;
      resultCard.classList.add('hidden');
      document.getElementById('quizCard').classList.remove('hidden');
      btnStart.disabled = true; btnNext.disabled = false; btnSubmit.disabled = true;
      renderQuestion();
    });

    btnNext.addEventListener('click', ()=>{
      lockQuestion('next');
      if (state.idx < QUESTIONS.length - 1){
        state.idx++; renderQuestion();
      }
      if (state.idx === QUESTIONS.length - 1){
        btnNext.disabled = true; btnSubmit.disabled = false;
      }
    });

    btnSubmit.addEventListener('click', ()=>{
      lockQuestion('submit');
      finishQuiz();
    });

    function finishQuiz(){
      const total = state.results.reduce((a,b)=> a + (b?.score||0), 0);
      const max = QUESTIONS.length * state.marks.correct;
      const correct = state.results.filter(r=>r?.isCorrect).length;
      const wrong = state.results.filter(r=>r && r.chosen!==null && !r.isCorrect).length;
      const unanswered = QUESTIONS.length - correct - wrong;
      const pct = Math.max(0, Math.round((total / max) * 100));

      finalScore.textContent = `${total} / ${max} (${pct}%)`;
      finalBreakdown.innerHTML = `
        <div>✅ Correct: <strong>${correct}</strong> &nbsp;|&nbsp; ❌ Wrong: <strong>${wrong}</strong> &nbsp;|&nbsp; ⏭️ Unanswered: <strong>${unanswered}</strong></div>
        <div style="margin-top:6px">Time taken: <strong>${formatTime(state.totalSeconds)}</strong> • Scoring: +${state.marks.correct} / -${state.marks.wrong} / -${state.marks.unanswered} (unanswered)</div>
      `;

      // Details table
      const rows = QUESTIONS.map((q, i)=>{
        const r = state.results[i] || {};
        const chosen = typeof r.chosen === 'number' ? q.options[r.chosen] : '—';
        const correctOpt = q.options[q.correct];
        const verdict = r.isCorrect ? 'Correct' : (typeof r.chosen === 'number' ? 'Wrong' : 'Unanswered');
        return `<tr>
          <td>${i+1}</td>
          <td>${escapeHtml(q.q)}</td>
          <td>${escapeHtml(chosen)}</td>
          <td>${escapeHtml(correctOpt)}</td>
          <td>${verdict}</td>
          <td style="text-align:right">${r.score ?? 0}</td>
        </tr>`;
      }).join('');
      detailTableWrap.innerHTML = `
        <table>
          <thead><tr><th>#</th><th>Question</th><th>Your Answer</th><th>Correct</th><th>Result</th><th style="text-align:right">Score</th></tr></thead>
          <tbody>${rows}</tbody>
        </table>`;

      resultCard.classList.remove('hidden');
      btnStart.disabled = false; btnNext.disabled = true; btnSubmit.disabled = true;
    }

    btnRetry.addEventListener('click', ()=>{
      btnStart.click();
      window.scrollTo({top:0, behavior:'smooth'});
    });

    // Download report as JSON
    btnDownload.addEventListener('click', ()=>{
      const report = {
        timestamp: new Date().toISOString(),
        settings: state.marks,
        totalSeconds: state.totalSeconds,
        results: state.results.map((r,i)=>({
          question: QUESTIONS[i].q,
          chosen: typeof r.chosen === 'number' ? QUESTIONS[i].options[r.chosen] : null,
          correct: QUESTIONS[i].options[QUESTIONS[i].correct],
          isCorrect: r.isCorrect,
          score: r.score
        })),
        totalScore: finalScore.textContent
      };
      const blob = new Blob([JSON.stringify(report, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'listening-quiz-report.json'; a.click();
      URL.revokeObjectURL(url);
    });

   function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, function (s) {
    switch (s) {
      case '&': return '&amp;';
      case '<': return '&lt;';
      case '>': return '&gt;';
      case '"': return '&quot;';
      case "'": return '&#39;';
      default: return s;
    }
  });
}

    function formatTime(sec){
      const m = Math.floor(sec/60); const s = sec%60; return `${m}m ${s}s`;
    }

    // Initialize UI
    timerEl.textContent = '--';
  </script>
</body>
</html>
